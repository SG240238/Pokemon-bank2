<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago de Servicios - Banco Pokémon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/servicios.css">
  <style>
    header {
      background: #2d2d2d;
      padding: 20px 0;
      text-align: center;
      color: white;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .main-historial-ancho {
      max-width: 1000px;
      width: 100%;
      align-items: center;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 24px;
      flex: 1;
    }
    footer {
      margin-top: auto;
      background: #333;
      color: white;
      text-align: center;
      padding: 15px 0;
      font-size: 0.9rem;
    }
    footer a {
      color: #ffc107;
      text-decoration: underline;
    }
    footer a:hover {
      color: #000;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png"
         style="width:100px; height:100px;" alt="Pikachu">
    <h2>Pokémon Bank</h2>
    <p>Bienvenido: Ash Ketchum | Cuenta: 0987654321</p>

    <nav>
      <a class="text-white mx-3" href="menu.html">Menu</a>
      <a class="text-white mx-3" href="deposito.html">Depósito</a>
      <a class="text-white mx-3" href="retiro.html">Retirar</a>
      <a class="text-white mx-3" href="consulta.html">Consulta</a>
      <a class="text-white mx-3" href="servicios.html">Pago de Servicios</a>
      <a class="text-white mx-3" href="historial.html">Historial</a>
      <a class="text-white mx-3" href="grafico.html">Análisis Gráfico</a>
      <a class="text-white mx-3" href="index.html">Salir</a>
    </nav>
  </header>

  <main class="container main-historial-ancho">
    <h3 class="mb-4 text-center">Gráficos Estadísticos</h3>
    <div class="d-flex justify-content-center mb-4" id="grafico-buttons">
      <button id="btn-estadisticos" class="btn btn-primary me-3" style="background: #667eea; border: none;">Gráfico Ingresos Versus Gastos</button>
      <button id="btn-tipo-pago" class="btn btn-primary" style="background: #764ba2; border: none;">Gráfico por Tipos de Movimientos</button>
    </div>

    <div id="titulo-grafico-estadistico" class="text-center mb-2" style="display: block; font-size: 1.3em; font-weight: bold; color: #333;">Gráfico Ingresos Versus Gastos</div>
    <div id="titulo-grafico-pastel" class="text-center mb-2" style="display: none; font-size: 1.3em; font-weight: bold; color: #333;">Gráfico por Tipos de Movimientos</div>
    <div class="table-responsive d-flex justify-content-center" style="min-height: 350px;">
      <canvas id="grafico-canvas" style="width: 700px; height: 350px; max-width: 100%; margin: 0 auto; display: block;"></canvas>
    </div>
  </main>

  <footer>
    Pokémon Bank S.A. de C.V. © 2025 — Atención: <a href="tel:800-123-4567">800-123-4567</a> | <a href="mailto:contacto@pokemonbank.com">contacto@pokemonbank.com</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/bank.js"></script>
  <script>
    const colorServicios = '#ffce56';
    const colorDepositos = '#36a2eb';
    const colorRetiros = '#e74c3c';

    const meses = [
      'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep'
    ];

    function getRandomData(n, min, max) {
      return Array.from({length: n}, () => Math.floor(Math.random() * (max - min + 1)) + min);
    }

    let chart;
    function mostrarGraficoEstadistico() {
      const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const hoy = new Date();
      let mesesGraficar = [];
      let mesesNumeros = [];
      for (let i = 3; i >= 0; i--) {
        let fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
        mesesGraficar.push(mesesNombres[fecha.getMonth()]);
        mesesNumeros.push(fecha.getMonth() + 1);
      }
      document.getElementById('titulo-grafico-estadistico').textContent = `Gráfico Ingresos Versus Gastos (${mesesGraficar[0]} - ${mesesGraficar[3]})`;
      document.getElementById('titulo-grafico-estadistico').style.display = 'block';
      document.getElementById('titulo-grafico-pastel').style.display = 'none';

      const user = typeof cargar === 'function' ? cargar() : null;
      const transacciones = user && user.transacciones ? user.transacciones : [];

      let ingresos = Array(4).fill(0);
      let gastos = Array(4).fill(0);
      let ingresosCount = Array(4).fill(0);
      let gastosCount = Array(4).fill(0);

      transacciones.forEach(tx => {
        if (!tx.fecha || !tx.monto) return;
        let mesNum = -1;
        if (tx.fecha.includes('/')) {
          const partes = tx.fecha.split(',')[0].split('/');
          if (partes.length >= 2) {
            mesNum = parseInt(partes[1], 10);
          }
        } else if (tx.fecha.includes('-')) {
          const partes = tx.fecha.split('-');
          if (partes.length >= 2) {
            mesNum = parseInt(partes[1], 10);
          }
        }
        const mesIdx = mesesNumeros.indexOf(mesNum);
        if (mesIdx === -1) return;
        if (tx.tipo === 'Depósito') {
          ingresos[mesIdx] += Number(tx.monto);
          ingresosCount[mesIdx] += 1;
        } else if (tx.tipo === 'Retiro' || tx.tipo === 'Pago de Servicio') {
          gastos[mesIdx] += Number(tx.monto);
          gastosCount[mesIdx] += 1;
        }
      });

      const canvas = document.getElementById('grafico-canvas');
      canvas.width = 700;
      canvas.height = 350;
      canvas.style.width = '100%';
      canvas.style.maxWidth = '700px';
      canvas.style.height = 'auto';
      const ctx = canvas.getContext('2d');
      if (chart) chart.destroy();

      const colorRojo = '#e74c3c';
      const colorVerde = '#2ecc71';

      function crearGraficoBarra() {
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: mesesGraficar,
            datasets: [
              {
                label: 'Ingresos',
                data: ingresos,
                backgroundColor: Array(4).fill(colorVerde),
                borderRadius: 8,
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  color: '#333',
                  font: { weight: 'bold', size: 14 },
                  formatter: function(value, context) {
                    return ingresosCount[context.dataIndex] + ' trx.';
                  }
                }
              },
              {
                label: 'Gastos',
                data: gastos,
                backgroundColor: Array(4).fill(colorRojo),
                borderRadius: 8,
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  color: '#333',
                  font: { weight: 'bold', size: 14 },
                  formatter: function(value, context) {
                    return gastosCount[context.dataIndex] + ' trx.';
                  }
                }
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#333', font: { weight: 'bold' } }
              },
              title: {
                display: false
              },
              datalabels: {
                display: true
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Mes',
                  color: '#333',
                  font: { weight: 'bold', size: 16 }
                },
                ticks: { color: '#333' }
              },
              y: {
                title: {
                  display: true,
                  text: 'Monto $',
                  color: '#333',
                  font: { weight: 'bold', size: 16 }
                },
                beginAtZero: true,
                ticks: { color: '#333' }
              }
            }
          },
          plugins: typeof ChartDataLabels !== 'undefined' ? [ChartDataLabels] : []
        });
      }
      if (typeof ChartDataLabels === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels';
        script.onload = function() { crearGraficoBarra(); };
        document.head.appendChild(script);
      } else {
        crearGraficoBarra();
      }
    }

    function mostrarGraficoTipoPago() {
      document.getElementById('titulo-grafico-estadistico').style.display = 'none';
      document.getElementById('titulo-grafico-pastel').style.display = 'block';

      const canvas = document.getElementById('grafico-canvas');
      canvas.width = 300;
      canvas.height = 150;
      canvas.style.width = '100%';
      canvas.style.maxWidth = '300px';
      canvas.style.height = 'auto';
      const ctx = canvas.getContext('2d');
      if (chart) chart.destroy();

      const user = typeof cargar === 'function' ? cargar() : null;
      const transacciones = user && user.transacciones ? user.transacciones : [];

      let montoServicios = 0, montoDepositos = 0, montoRetiros = 0;
      let countServicios = 0, countDepositos = 0, countRetiros = 0;
      transacciones.forEach(tx => {
        if (tx.tipo === 'Pago de Servicio') {
          montoServicios += Number(tx.monto);
          countServicios++;
        } else if (tx.tipo === 'Depósito') {
          montoDepositos += Number(tx.monto);
          countDepositos++;
        } else if (tx.tipo === 'Retiro') {
          montoRetiros += Number(tx.monto);
          countRetiros++;
        }
      });
      const tiposGrafico = ['Pago de Servicio', 'Depósitos', 'Retiros'];
      const valores = [montoServicios, montoDepositos, montoRetiros];
      const transaccionesPorTipo = [countServicios, countDepositos, countRetiros];
      const total = valores.reduce((a, b) => a + b, 0);

      function crearGraficoPastel() {
        chart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: tiposGrafico,
            datasets: [{
              data: valores,
              backgroundColor: [colorServicios, colorDepositos, colorRetiros],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const idx = context.dataIndex;
                    const tipo = tiposGrafico[idx];
                    const valor = valores[idx];
                    const cantidad = transaccionesPorTipo[idx];
                    const porcentaje = total > 0 ? ((valor / total) * 100).toFixed(1) : 0;
                    return `${tipo}: $${valor} (${porcentaje}%)\nTransacciones: ${cantidad}`;
                  }
                }
              },
              datalabels: {
                display: true,
                color: '#333',
                font: { weight: 'bold', size: 14 },
                formatter: function(value, context) {
                  const tipo = tiposGrafico[context.dataIndex];
                  const cantidad = transaccionesPorTipo[context.dataIndex];
                  const porcentaje = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${tipo}\n$${value}\n${porcentaje}%\n${cantidad} trx.`;
                }
              }
            }
          },
          plugins: typeof ChartDataLabels !== 'undefined' ? [ChartDataLabels] : []
        });
      }
      if (typeof ChartDataLabels === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels';
        script.onload = function() { crearGraficoPastel(); };
        document.head.appendChild(script);
      } else {
        crearGraficoPastel();
      }
    }

    document.getElementById('btn-estadisticos').addEventListener('click', mostrarGraficoEstadistico);
    document.getElementById('btn-tipo-pago').addEventListener('click', mostrarGraficoTipoPago);

    mostrarGraficoEstadistico();
  </script>
</body>
</html>
